<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/__tests__/CoreWorkerTest.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/CircleOfNice/CoreWorker" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DuplexStream.js~DuplexStream.html">DuplexStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Process">Process</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-process">process</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Condition">Condition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DuplexStream">DuplexStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ExitCode">ExitCode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ExitCodes">ExitCodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Instance">Instance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-MaybeExitCodes">MaybeExitCodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NodeProcess">NodeProcess</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-null">null</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Process">Process</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RegExp">RegExp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Result">Result</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Validator">Validator</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/__tests__/CoreWorkerTest.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/*
 * This file is part of CoreWorker.
 *
 * CoreWorker is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * CoreWorker is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with CoreWorker.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 *
 * Copyright 2016 TeeAge-Beatz UG (haftungsbeschr&#xE4;nkt)
 */

import { process } from &quot;../index&quot;;
import assert from &quot;assert&quot;;
import Result from &quot;../Result.type&quot;;
import T from &quot;tcomb&quot;;
import { Writable } from &quot;stream&quot;;
import path from &quot;path&quot;;

const counterScript  = path.join(__dirname, &quot;/Scripts/CounterScript.js&quot;);
const stdinLogger    = path.join(__dirname, &quot;/Scripts/StdinLogger.js&quot;);
const failScript     = path.join(__dirname, &quot;/Scripts/FailScript.js&quot;);
const exitCodeScript = path.join(__dirname, &quot;/Scripts/ExitCodeScript.js&quot;);
const killScript     = path.join(__dirname, &quot;/Scripts/KillScript.js&quot;);

describe(&quot;CoreWorker&quot;, function() { //eslint-disable-line
    it(&quot;executes an application and waits until it is ready&quot;, async function(done) {
        this.timeout(5000);
        const counter = process(`node ${counterScript}`, &quot;Log No. 10&quot;);

        try {
            const result = await counter.ready(2000);

            assert.deepStrictEqual(
                result.output.join(&quot;&quot;),
                &quot;Log No. 1\n&quot; +
                &quot;Log No. 2\n&quot; +
                &quot;Log No. 3\n&quot; +
                &quot;Log No. 4\n&quot; +
                &quot;Log No. 5\n&quot; +
                &quot;Log No. 6\n&quot; +
                &quot;Log No. 7\n&quot; +
                &quot;Log No. 8\n&quot; +
                &quot;Log No. 9\n&quot; +
                &quot;Log No. 10\n&quot;
            );

            assert.equal(result.isRunning, true, &quot;Expected process to be running&quot;);
            assert(T.Number.is(result.pid) &amp;&amp; result.pid &gt; 0, &quot;Should have a pid&quot;);

            assert.equal(
                (await counter.kill()).data.indexOf(
                    &quot;Log No. 1\n&quot; +
                    &quot;Log No. 2\n&quot; +
                    &quot;Log No. 3\n&quot; +
                    &quot;Log No. 4\n&quot; +
                    &quot;Log No. 5\n&quot; +
                    &quot;Log No. 6\n&quot; +
                    &quot;Log No. 7\n&quot; +
                    &quot;Log No. 8\n&quot; +
                    &quot;Log No. 9\n&quot; +
                    &quot;Log No. 10\n&quot; +
                    &quot;Log No. 11\n&quot;
                ),
                0
            );
            done();
        } catch(err) {
            done(err);
        }
    });

    it(&quot;executes an application and waits until it is ready&quot;, async function(done) {
        const counter = process(`node ${counterScript}`, /Log\ No\.\ 5/);

        try {
            const result = await counter.ready(2000); // eslint-disable-line

            assert.deepStrictEqual(result.output, [
                &quot;Log No. 1\n&quot;,
                &quot;Log No. 2\n&quot;,
                &quot;Log No. 3\n&quot;,
                &quot;Log No. 4\n&quot;,
                &quot;Log No. 5\n&quot;
            ]);

            assert.equal(result.isRunning, true, &quot;Expected process to be running&quot;);
            assert(T.Number.is(result.pid) &amp;&amp; result.pid &gt; 0, &quot;Should have a pid&quot;);

            await counter.kill();
            done();
        } catch(err) {
            done(err);
        }
    });

    it(&quot;executes an application, waits until it is ready, but exceeds given timeout&quot;, async function(done) {
        const counter = process(`node ${counterScript}`, &quot;Log No. 10&quot;);

        try {
            const result = await counter.ready(10);

            assert.deepStrictEqual(result, Result({ data: null }), &quot;Result should contain null&quot;);
            done(new Error(&quot;This shouldn&apos;t finish.&quot;));
        } catch(err) {
            assert.equal(err.message, &quot;Timeout exceeded.&quot;, &quot;Timeout Error should be thrown&quot;);

            await counter.kill();
            done();
        }
    });

    it(&quot;executes an application and waits its death&quot;, async function(done) {
        const counter = process(`node ${counterScript}`, /Log\ No\.\ 10/);

        try {
            const result = await counter.death();

            result.data
                .slice(0, -1)
                .split(&quot;\n&quot;)
                .forEach(function(row, iterator) {
                    assert(row === `Log No. ${iterator + 1}`, `Wrong output: ${row}, expected:\n Log No. ${iterator + 1}`);
                });
            done();
        } catch(err) {
            done(err);
        }
    });

    it(&quot;executes an application and waits its death with a spedified timeout&quot;, async function(done) {
        const counter = process(`node ${counterScript}`, /Log\ No\.\ 10/);

        try {
            const result = await counter.death(500);

            result.data
                .slice(0, -1)
                .split(&quot;\n&quot;)
                .forEach(function(row, iterator) {
                    assert(row === `Log No. ${iterator + 1}`, `Wrong output: ${row}, expected:\n Log No. ${iterator + 1}`);
                });
            done();
        } catch(err) {
            done(err);
        }
    });

    it(&quot;executes an application, waits its death, but exceeds given timeout&quot;, async function(done) {
        const counter = process(`node ${counterScript}`, /Log\ No\.\ 10/);

        try {
            await counter.death(10);
            done(new Error(&quot;Shouldn&apos;t resolve here&quot;));
        } catch(err) {
            assert.equal(err.message, &quot;Timeout exceeded.&quot;, &quot;Timeout Error should be thrown&quot;);

            await counter.kill();
            done();
        }
    });

    it(&quot;executes an application and handles it as a stream&quot;, function(done) {
        const inputLogger = process(`node ${stdinLogger}`, &quot;&quot;);
        const writable    = Writable();
        const stream      = inputLogger.stream();

        writable.write = function(chunk) {
            assert.equal(chunk, &quot;Hello\n&quot;);
            inputLogger.kill().then(() =&gt; done()).catch(done);
        };

        stream.pipe(writable);
        stream.write(&quot;Hello&quot;);
    });

    it(&quot;executes an application, but terminates unexpectedly&quot;, async function(done) {
        const failProcess = process(`node ${failScript}`);

        try {
            await failProcess.death(1000);
            done(new Error(&quot;Shouldn&apos;t resolve here&quot;));
        } catch(err) {
            assert.equal(err.message, &quot;Process was closed unexpectedly. Code: 1&quot;, &quot;Message should be closing code with 1&quot;);
            done();
        }
    });

    it(&quot;executes an application, awaits its death and terminates with valid exit code&quot;, async function(done) {
        try {
            const validExitCodeProcess = process(`node ${exitCodeScript}`);
            const result               = await validExitCodeProcess.death(1000, 128);

            assert.equal(result.data, &quot;Process exited with code 100&quot;);
            done();
        } catch(err) {
            done(err);
        }
    });

    it(&quot;executes an application and kills it&quot;, async function(done) {
        try {
            const liveProcess = process(`node ${killScript}`, /Kill me/);

            await liveProcess.ready(1000);
            await liveProcess.kill();
            done();
        } catch(err) {
            assert.equal(err.message, &quot;Process was closed unexpectedly. Code: 137&quot;);
            done();
        }
    });

    it(&quot;executes an application, kills it and terminates with valid exit code&quot;, async function(done) {
        try {
            const liveProcess = process(`node ${killScript}`, /Kill me/);

            await liveProcess.ready(1000);

            const result = await liveProcess.kill([137]);

            assert.equal(result.data, &quot;Kill me&quot;);
            done();
        } catch(err) {
            done(err);
        }
    });
});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
